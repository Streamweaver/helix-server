# Ref: https://github.com/aws-samples/startup-kit-templates/blob/master/templates/elasticache.cfn.yml
AWSTemplateFormatVersion: 2010-09-09

Parameters:

  App:
    Type: String
    Description: Your application's name.

  Env:
    Type: String
    Description: The environment name your service, job, or workflow is being deployed to.

  Name:
    Type: String
    Description: The name of the service, job, or workflow being deployed.

  ClusterName:
    Type: String
    Description: The name of the initial database to be created in the DB cluster.
    Default: helix-redis-cluster

  CacheNodeType:
    Description: Cache node instance class, e.g. cache.t2.micro(free tier). See https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/CacheNodes.SelectSize.html
    Type: String
    Default: cache.t2.micro
    ConstraintDescription: Node instance class not supported
    AllowedValues:
      - cache.t2.micro
      - cache.t2.small
      - cache.t2.medium
      - cache.m4.large
      - cache.m4.xlarge
      - cache.m4.2xlarge
      - cache.m4.4xlarge
      - cache.m4.10xlarge
      - cache.r4.large
      - cache.r4.xlarge
      - cache.r4.2xlarge
      - cache.r4.4xlarge
      - cache.r4.8xlarge
      - cache.r4.16xlarge

  CacheNodeCount:
    Description: Number of nodes in the cluster. Only used with memcached engine, for redis this value will be set to 1.
    Type: Number
    MinValue: 1
    MaxValue: 15
    ConstraintDescription: Node count must be between 1 and 15
    Default: 1

  AutoMinorVersionUpgrade:
    Description: Whether or not minor version upgrades to the cache engine should be applied automatically during the maintenance window.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false

Resources:

  SubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Cache Subnet Group
      SubnetIds:
        !Split [',', { 'Fn::ImportValue': !Sub '${App}-${Env}-PrivateSubnets' }]

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ElastiCache Security Group
      VpcId:
        Fn::ImportValue:
          !Sub '${App}-${Env}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          Description: !Sub 'From the ElastiCache Security Group of the workload ${Name}.'
          SourceSecurityGroupId: { 'Fn::ImportValue': !Sub '${App}-${Env}-EnvironmentSecurityGroup' }
      Tags:
        - Key: 'copilot-application'
          Value: !Sub '${App}'
        - Key: 'copilot-environment'
          Value: !Sub '${Env}'

  ElastiCacheCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      AutoMinorVersionUpgrade: !Ref AutoMinorVersionUpgrade
      Engine: 'redis'
      CacheNodeType: !Ref CacheNodeType
      ClusterName : !Ref ClusterName
      NumCacheNodes: !Ref CacheNodeCount
      CacheSubnetGroupName: !Ref SubnetGroup
      VpcSecurityGroupIds:
        - !Ref SecurityGroup
      Tags:
        - Key: 'copilot-application'
          Value: !Sub '${App}'
        - Key: 'copilot-environment'
          Value: !Sub '${Env}'

Outputs:

  ElastiCacheClusterArn:
    Description: ElastiCache Cluster Arn
    Value: !Sub arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster/${ElastiCacheCluster}
    Export:
      Name: !Sub ${App}-${Env}-ElastiCacheClusterArn

  ElastiCacheClusterId:
    Description: ElastiCache Cluster ID
    Value: !Ref ElastiCacheCluster
    Export:
      Name: !Sub ${App}-${Env}-ElastiCacheClusterID

  ElastiCacheAddress: # env var ELASTI_CACHE_ADDRESS
    Description: ElastiCache endpoint address
    Value: !GetAtt ElastiCacheCluster.RedisEndpoint.Address
    Export:
      Name: !Sub ${App}-${Env}-ElastiCacheAddress

  ElastiCachePort: # env var ELASTI_CACHE_PORT
    Description: ElastiCache port
    Value: 6379
    Export:
      Name: !Sub ${App}-${Env}-ElastiCachePort
