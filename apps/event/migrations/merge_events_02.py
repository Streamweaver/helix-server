import csv
from io import StringIO

from collections import defaultdict
from django.db import migrations
from django.conf import settings

from apps.contrib.migrate_commands import merge_events as update_figures_and_merge_events


# https://github.com/idmc-labs/helix2.0-meta/issues/1066
DATA = """figure_id,event_id,new_event_id
10313,12474,12662
40211,12814,12662
51124,11358,12662
55193,11358,12662
57876,11358,12662
60157,11358,12662
103391,14721,12662
103394,14721,12662
103395,14721,12662
2375,12817,12698
3502,12804,12698
11201,12447,12698
43006,12804,12698
45283,12557,12698
45419,12615,12698
46159,12563,12698
46160,12627,12698
47016,12627,12698
47065,12543,12698
47079,12627,12698
47115,12447,12698
51607,12447,12698
51839,12447,12698
53237,12563,12698
55262,12447,12698
59844,11327,12698
100227,14476,12698
137175,21404,12698
137176,21404,12698
137177,21404,12698
137178,21404,12698
137179,21404,12698
137180,21404,12698
137181,21404,12698
302,12365,22012
36678,12365,22012
40366,12697,22012
40442,12510,22012
42309,12717,22012
42311,12334,22012
45421,12510,22012
45454,12334,22012
45713,12365,22012
46096,12697,22012
47071,12622,22012
48470,12622,22012
48586,12622,22012
48587,12622,22012
48588,12622,22012
48590,12622,22012
48594,12622,22012
48599,12622,22012
49029,12622,22012
49030,12622,22012
49035,12622,22012
49036,12622,22012
49037,12622,22012
49038,12622,22012
49041,12622,22012
51441,12622,22012
51498,12622,22012
51503,12622,22012
51518,12622,22012
52692,12844,22012
55406,12699,22012
55407,12699,22012
55408,12699,22012
55410,12699,22012
55411,12699,22012
55412,12699,22012
55413,12699,22012
55415,12699,22012
55416,12699,22012
55417,12699,22012
55418,12699,22012
55776,12699,22012
56003,12365,22012
56124,12699,22012
57683,12334,22012
58693,12510,22012
59544,12622,22012
59547,12622,22012
59548,12622,22012
59550,12622,22012
60588,12510,22012
104257,14939,22012
104258,14939,22012
104259,14939,22012
104260,14939,22012
104261,14939,22012
104262,14939,22012
104263,14939,22012
104264,14939,22012
104265,14939,22012
104266,14939,22012
104267,14939,22012
3680,12549,14739
11035,12549,14739
11036,12549,14739
45234,12656,12803
47706,12430,12803
21718,12562,14739
21719,12562,14739
21720,12562,14739
21721,12562,14739
21722,12562,14739
21631,12562,14739
21632,12562,14739
36858,11499,14739
36859,11499,14739
36860,11499,14739
36861,11499,14739
36862,11499,14739
21734,12562,14739
37797,11499,14739
37798,11499,14739
37799,11499,14739
37800,11499,14739
37801,11499,14739
36235,11357,14739
38406,11499,14739
38408,11499,14739
38410,11499,14739
38411,11499,14739
38413,11499,14739
36863,11499,14739
38801,11499,14739
38803,11499,14739
38804,11499,14739
38806,11499,14739
38808,11499,14739
37802,11499,14739
39664,11499,14739
39665,11499,14739
39666,11499,14739
39667,11499,14739
39668,11499,14739
38414,11499,14739
38809,11499,14739
39783,12255,14739
39918,12255,14739
40969,12255,14739
41829,12255,14739
41928,12255,14739
41931,12255,14739
41932,12255,14739
42632,12255,14739
39669,11499,14739
39759,12255,14739
42692,12255,14739
42695,12255,14739
42696,12255,14739
42697,12255,14739
42698,12255,14739
42699,12255,14739
42700,12255,14739
42702,12255,14739
42705,12255,14739
42917,12255,14739
42923,12255,14739
42934,12255,14739
43068,12255,14739
43098,12255,14739
43871,12255,14739
43878,12255,14739
44072,12255,14739
44258,12255,14739
44277,12255,14739
44281,12255,14739
44289,12255,14739
45061,12255,14739
45176,12255,14739
45177,12255,14739
45693,12255,14739
45789,12549,14739
45823,12549,14739
45953,12549,14739
45976,12549,14739
46066,12549,14739
46073,12549,14739
46076,12549,14739
46310,12549,14739
42706,12255,14739
42707,12255,14739
48573,12562,14739
48575,12562,14739
48576,12562,14739
48657,12562,14739
48658,12562,14739
48663,12562,14739
48664,12562,14739
48670,12562,14739
48671,12562,14739
48677,12562,14739
48700,12562,14739
48703,12562,14739
48717,12562,14739
49060,12562,14739
49061,12562,14739
49062,12562,14739
49063,12562,14739
49066,12562,14739
46665,12549,14739
47495,12255,14739
49071,12562,14739
49122,12562,14739
50839,12562,14739
50843,12562,14739
51426,12562,14739
51436,12562,14739
52128,12562,14739
52136,12562,14739
52140,12562,14739
52399,12562,14739
52406,12562,14739
52407,12562,14739
52610,12347,14739
52706,12347,14739
53104,11357,14739
53286,12530,14739
53901,12530,14739
53902,12530,14739
54298,12530,14739
54391,12347,14739
54443,12530,14739
54470,12530,14739
54601,12347,14739
54878,12347,14739
55010,12530,14739
55066,12347,14739
49072,12562,14739
49074,12562,14739
55564,11357,14739
55752,12530,14739
56981,11357,14739
56985,12347,14739
57129,12347,14739
57159,12347,14739
57161,12347,14739
55354,12530,14739
57478,12347,14739
55355,12530,14739
57809,12347,14739
57163,12347,14739
57537,12347,14739
58047,12347,14739
58253,12347,14739
58254,12347,14739
59090,12549,14739
59092,12549,14739
59093,12549,14739
59109,12549,14739
59161,12549,14739
57819,12347,14739
59276,12347,14739
59441,12562,14739
59442,12562,14739
59445,12562,14739
59449,12562,14739
59468,12562,14739
59469,12562,14739
59472,12562,14739
59476,12562,14739
59517,12347,14739
59519,12347,14739
59520,12347,14739
59537,12347,14739
59553,12347,14739
59558,12347,14739
59559,12347,14739
59560,12347,14739
59561,12347,14739
58042,12347,14739
59261,12549,14739
59577,11357,14739
59804,11357,14739
59825,12347,14739
59826,12347,14739
59827,12347,14739
59828,12347,14739
59829,12347,14739
59832,12347,14739
59562,12347,14739
59838,12347,14739
59839,12347,14739
59840,12347,14739
59568,12562,14739
59843,12347,14739
59971,12562,14739
59975,12562,14739
60026,12562,14739
60029,12562,14739
60030,12562,14739
60031,12562,14739
60189,12530,14739
60195,12530,14739
59837,12347,14739
66723,11499,14739
66765,11499,14739
66766,11499,14739
66767,11499,14739
66768,11499,14739
59842,12347,14739
66785,11499,14739
66786,11499,14739
66787,11499,14739
66788,11499,14739
66789,11499,14739
60584,12255,14739
69411,11499,14739
69412,11499,14739
69413,11499,14739
69414,11499,14739
69415,11499,14739
74854,11499,14739
74855,11499,14739
74856,11499,14739
74857,11499,14739
74858,11499,14739
87397,11499,14739
87398,11499,14739
87399,11499,14739
87400,11499,14739
87401,11499,14739
100284,11499,14739
100285,11499,14739
100286,11499,14739
100287,11499,14739
100288,11499,14739
107661,15520,14739
45179,12656,12803
66769,11356,14739
66790,11356,14739
49144,11360,12803
51787,12656,12803
55253,12430,12803
58385,12430,12803
60013,11360,12803
60017,11360,12803
103953,14850,12803
33917,11361,14739
46990,12411,14739
47046,12413,14739
58713,11361,14739
100273,14479,14739
134343,20912,14739
"""


def merge_events(*_):
    if settings.TESTING:
        return

    reader = csv.DictReader(
        StringIO(DATA),
        delimiter=',',
    )
    event_ids_mapping = defaultdict(list)
    figure_event_map = {}

    for row in reader:
        event_ids_mapping[row['new_event_id']].append(row['event_id'])
        figure_event_map[row['figure_id']] = row['new_event_id']

    update_figures_and_merge_events(event_ids_mapping, figure_event_map=figure_event_map)


class Migration(migrations.Migration):

    dependencies = [
        ('event', 'merge_events'),
    ]

    operations = [
        migrations.RunPython(merge_events, reverse_code=migrations.RunPython.noop),
    ]
