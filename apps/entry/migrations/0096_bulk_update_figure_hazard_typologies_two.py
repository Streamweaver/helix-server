# Generated by Django 3.2 on 2023-10-03 17:29
from django.db import migrations


def update_figure_hazard_typologies(apps, _):
    Figure = apps.get_model('entry', 'Figure')
    DisasterSubType = apps.get_model('event', 'DisasterSubType')

    figures_data = [
        {"figure_id": 40481, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 41463, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 40256, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 40258, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 40255, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 58179, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 46223, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 56959, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 51626, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 46221, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 46224, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39222, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39223, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39488, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39245, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39226, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39139, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39063, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39237, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39094, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39144, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39225, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 93946, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39246, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39060, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 10733, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 109822, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 42381, "new_hazard_sub_type": "Drought"},
        {"figure_id": 42597, "new_hazard_sub_type": "Flood"},
        {"figure_id": 43015, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45522, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40922, "new_hazard_sub_type": "Earthquake"},
        {"figure_id": 45657, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42796, "new_hazard_sub_type": "Flood"},
        {"figure_id": 39904, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45528, "new_hazard_sub_type": "Drought"},
        {"figure_id": 42657, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 41120, "new_hazard_sub_type": "Storm"},
        {"figure_id": 45716, "new_hazard_sub_type": "Flood"},
        {"figure_id": 39995, "new_hazard_sub_type": "Storm"},
        {"figure_id": 105560, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45183, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 41427, "new_hazard_sub_type": "Storm"},
        {"figure_id": 42732, "new_hazard_sub_type": "Flood"},
        {"figure_id": 105561, "new_hazard_sub_type": "Flood"},
        {"figure_id": 60529, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 39774, "new_hazard_sub_type": "Earthquake"},
        {"figure_id": 42051, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45706, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 40330, "new_hazard_sub_type": "Storm"},
        {"figure_id": 45710, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 46314, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 105562, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42059, "new_hazard_sub_type": "Storm"},
        {"figure_id": 105564, "new_hazard_sub_type": "Flood"},
        {"figure_id": 44071, "new_hazard_sub_type": "Flood"},
        {"figure_id": 44070, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45157, "new_hazard_sub_type": "Flood"},
        {"figure_id": 39860, "new_hazard_sub_type": "Flood"},
        {"figure_id": 105556, "new_hazard_sub_type": "Flood"},
        {"figure_id": 105559, "new_hazard_sub_type": "Flood"},
        {"figure_id": 44210, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 57842, "new_hazard_sub_type": "Flood"},
        {"figure_id": 46328, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41897, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40914, "new_hazard_sub_type": "Avalanche"},
        {"figure_id": 41201, "new_hazard_sub_type": "Earthquake"},
        {"figure_id": 41924, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41217, "new_hazard_sub_type": "Earthquake"},
        {"figure_id": 45156, "new_hazard_sub_type": "Flood"},
        {"figure_id": 57726, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40177, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42060, "new_hazard_sub_type": "Storm"},
        {"figure_id": 39767, "new_hazard_sub_type": "Flood"},
        {"figure_id": 46322, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 105558, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40427, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41775, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 45152, "new_hazard_sub_type": "Storm"},
        {"figure_id": 42840, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 46320, "new_hazard_sub_type": "Storm"},
        {"figure_id": 41257, "new_hazard_sub_type": "Flood"},
        {"figure_id": 10775, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 10776, "new_hazard_sub_type": "Landslide/Wet mass movement"},
        {"figure_id": 39766, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42269, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45147, "new_hazard_sub_type": "Flood"},
        {"figure_id": 57843, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42626, "new_hazard_sub_type": "Flood"},
        {"figure_id": 39863, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42627, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42273, "new_hazard_sub_type": "Flood"},
        {"figure_id": 105372, "new_hazard_sub_type": "Flood"},
        {"figure_id": 49219, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40505, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41214, "new_hazard_sub_type": "Earthquake"},
        {"figure_id": 45730, "new_hazard_sub_type": "Flood"},
        {"figure_id": 46327, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41024, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42660, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42980, "new_hazard_sub_type": "Flood"},
        {"figure_id": 44080, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 44177, "new_hazard_sub_type": "Storm"},
        {"figure_id": 40554, "new_hazard_sub_type": "Flood"},
        {"figure_id": 44215, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42624, "new_hazard_sub_type": "Flood"},
        {"figure_id": 50790, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42543, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42539, "new_hazard_sub_type": "Flood"},
        {"figure_id": 39874, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41299, "new_hazard_sub_type": "Flood"},
        {"figure_id": 46321, "new_hazard_sub_type": "Storm"},
        {"figure_id": 41744, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40972, "new_hazard_sub_type": "Storm"},
        {"figure_id": 42383, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 42540, "new_hazard_sub_type": "Flood"},
        {"figure_id": 105563, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42992, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40503, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42333, "new_hazard_sub_type": "Flood"},
        {"figure_id": 39717, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41457, "new_hazard_sub_type": "Flood"},
        {"figure_id": 105557, "new_hazard_sub_type": "Flood"},
        {"figure_id": 57871, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41317, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42335, "new_hazard_sub_type": "Storm"},
        {"figure_id": 42341, "new_hazard_sub_type": "Storm"},
        {"figure_id": 42345, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42362, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42364, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40917, "new_hazard_sub_type": "Avalanche"},
        {"figure_id": 74108, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 41246, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40811, "new_hazard_sub_type": "Storm"},
        {"figure_id": 60654, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42771, "new_hazard_sub_type": "Storm"},
        {"figure_id": 41284, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40967, "new_hazard_sub_type": "Storm"},
        {"figure_id": 40522, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41363, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41364, "new_hazard_sub_type": "Flood"},
        {"figure_id": 51595, "new_hazard_sub_type": "Storm"},
        {"figure_id": 41408, "new_hazard_sub_type": "Flood"},
        {"figure_id": 41124, "new_hazard_sub_type": "Drought"},
        {"figure_id": 42514, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 45182, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 40687, "new_hazard_sub_type": "Flood"},
        {"figure_id": 42919, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 40349, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 42171, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 42731, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 45083, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 45088, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 59930, "new_hazard_sub_type": "Flood"},
        {"figure_id": 40703, "new_hazard_sub_type": "Flood"},
        {"figure_id": 45084, "new_hazard_sub_type": "Wildfire"},
        {"figure_id": 45148, "new_hazard_sub_type": "Flood"},
        {"figure_id": 44110, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 45175, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 42688, "new_hazard_sub_type": "Typhoon/Hurricane/Cyclone"},
        {"figure_id": 46641, "new_hazard_sub_type": "Drought"},
        {"figure_id": 43964, "new_hazard_sub_type": "Flood"},
        {"figure_id": 58178, "new_hazard_sub_type": "Avalanche"},
        {"figure_id": 42095, "new_hazard_sub_type": "Avalanche"},
        {"figure_id": 59929, "new_hazard_sub_type": "Flood"},
        {"figure_id": 51587, "new_hazard_sub_type": "Storm"},
        {"figure_id": 112914, "new_hazard_sub_type": "Storm"}
    ]

    disaster_sub_type_map = {
        i.name: i for i in DisasterSubType.objects.all()
    }

    updated_figures = 0
    for row in figures_data:
        figure_id = row['figure_id']
        hazard_sub_type_name = row['new_hazard_sub_type']

        figure = Figure.objects.filter(id=figure_id).first()
        if figure is None:
            print(f'The figure with id {figure_id} is missing')
            continue

        disaster_sub_type = disaster_sub_type_map[hazard_sub_type_name]

        figure.event.disaster_sub_type = disaster_sub_type
        figure.event.save(update_fields=['disaster_sub_type'])

        figure.disaster_sub_type = disaster_sub_type
        figure.save(update_fields=['disaster_sub_type'])

        updated_figures += 1

    print(f'Updated disaster subtype for {updated_figures} figures')


def update_idus(apps, _):
    Figure = apps.get_model('entry', 'Figure')

    figures_id = [
        109292,
        109293,
        109294,
        109295,
        109296,
        109297,
        118732,
        118733,
        118734,
        118735,
        118736,
        118737,
        118738,
        118739,
        118740,
        118980,
        118981,
        118982,
        118983,
        118984,
        118985,
        118986,
        118987,
        118988,
        118989,
        118990,
        118991,
        118992,
        118993,
        118994,
        118995,
        118996,
        118997,
        118998,
        119083,
        119084,
        119085,
        119086,
        119087,
        119088,
        119089,
        119090,
        119091,
        119092,
        119093,
        119094,
        119095,
        119096,
        119097,
        119098,
        119099,
        119100,
        119103,
        119104,
        119105,
        119106,
        119107,
        119108,
        119109,
        119110,
        119111,
        119112,
        119113,
        119114,
        119115,
        119116,
        119117,
        119118,
        119119,
        119120,
        119121,
        119122,
    ]

    figure_qs = Figure.objects.filter(id__in=figures_id, role=0)
    figure_qs.update(include_idu=True)
    print(f'Updated idus for {figure_qs.count()} figures')


def delete_triangulation_figures(apps, _):
    Figure = apps.get_model('entry', 'Figure')

    figures_id = [
        109089,
        109090,
        109091,
        109092,
        109093,
        109094,
        109095,
        109096,
        109099,
        109100,
        109101,
        109102,
        109103,
        109104,
        109105,
        109106,
        109107,
        109108,
        109109,
        109110,
        109111,
        109115,
        109116,
        109117,
        109118,
        109119,
        109120,
        109121,
        109122,
        109123,
        109130,
        109131,
        109132,
        109133,
        109141,
        109142,
        109143,
        109144,
        109145,
        109146,
        109147,
        109148,
        109149,
        109150,
        109151,
        109158,
        109159,
        109160,
        109161,
        109162,
        109163,
        109164,
        109165,
        109166,
        109167,
        109168,
        109169,
        109170,
        109171,
        109172,
        109174,
        109175,
        109176,
        109177,
        109178,
        109179,
        109180,
        109181,
        109613,
        109615,
        113004,
        113005,
        113006,
        113007,
        113008,
        113009,
        113010,
        113011,
    ]

    # NOTE: Only delete triangulation figures
    deleted = Figure.objects.filter(id__in=figures_id, role=1).delete()
    print(f'Deleted {deleted} when deleting figures')


def cleanup_deprecated_external_api_type(apps, _):
    ClientTrackInfo = apps.get_model('contrib', 'ClientTrackInfo')

    # Delete client track info for apis that are deprecated
    deleted = ClientTrackInfo.objects.filter(
        api_type='gidd-conflict-export-rest'
    ).delete()
    print(f'Deleted {deleted} when deleting client track info')


class Migration(migrations.Migration):

    dependencies = [
        ('entry', '0095_merge_20231002_1725'),
    ]

    operations = [
        migrations.RunPython(update_figure_hazard_typologies, reverse_code=migrations.RunPython.noop),
        migrations.RunPython(update_idus, reverse_code=migrations.RunPython.noop),
        migrations.RunPython(delete_triangulation_figures, reverse_code=migrations.RunPython.noop),
        migrations.RunPython(cleanup_deprecated_external_api_type, reverse_code=migrations.RunPython.noop),
    ]
