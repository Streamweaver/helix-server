# Generated by Django 3.0.14 on 2023-03-22 14:10

import csv
from functools import lru_cache
from io import StringIO
from django.db import migrations

CSV_DATE = '''
figure_old_id,event_old_id,figure_role
4183,742,0
4203,318,0
4295,726,0
4450,802,0
4559,830,0
4560,830,0
5676,1110,0
5677,1110,0
5681,1110,0
5682,1110,0
5691,1117,0
5695,1117,0
5781,1154,0
5783,1154,0
5843,1175,0
5926,1217,0
5927,1217,0
6139,1225,1
6141,1225,1
6145,1225,1
6157,1225,1
6158,1225,1
6191,1225,0
6360,1278,0
6361,1278,1
6375,1281,0
6471,1287,1
6479,1287,1
6481,1287,1
6483,1287,0
6516,1281,1
6517,1281,1
6631,1336,0
6632,1336,0
7046,1398,0
7048,1398,0
7051,1398,0
7522,1449,1
7523,1449,0
7580,1465,0
7581,1465,0
7746,1449,0
7828,1554,0
7830,1554,0
7845,854,1
7927,1217,1
7933,1217,1
7942,1217,1
8396,1287,1
8636,1225,0
8644,1225,0
8648,1225,0
8652,1225,0
8654,1711,0
8657,1711,0
9442,1803,0
9444,1803,0
9445,1803,0
9446,1803,0
9447,1803,0
9450,1803,0
9451,1803,0
9452,1803,0
9882,1831,0
9883,1831,0
10497,1985,0
10749,2065,0
10761,2065,0
10941,2139,0
10942,2139,0
11395,2293,0
11407,2219,0
11420,2215,0
12017,2320,0
12019,2320,0
12026,2215,0
12028,2215,0
12068,2215,0
12216,2378,0
12247,2215,0
12431,2436,0
12432,2436,0
12589,2215,0
12614,2215,0
12669,2507,0
12681,2507,0
12696,2507,0
12698,2507,0
12699,2507,0
12715,2378,0
12988,2754,0
13030,2575,0
13031,2575,0
13033,2754,0
13314,2027,0
13458,2627,1
13559,2645,0
13560,2645,0
13585,2655,0
13586,2655,0
13588,2657,0
13589,2657,0
13592,2658,0
13593,2658,0
13598,2660,0
13599,2660,0
13666,2627,1
13701,2679,0
13702,2679,0
13741,2680,0
13742,2680,0
13743,2680,0
13748,2684,0
13749,2684,0
13752,2335,0
13753,2335,1
13754,2335,1
13755,2335,1
13756,2335,0
13761,2335,0
13763,2335,0
13764,2335,1
13765,2335,1
13767,2335,1
13768,2335,1
13769,2335,0
13771,2690,0
13780,2335,1
13781,2335,1
13782,2335,0
13783,2335,0
13784,2335,0
13786,2335,1
13787,2335,0
13788,2335,1
13789,2335,1
13790,2335,0
13791,2335,0
13815,2335,1
13816,2335,1
13817,2335,0
13819,2335,0
13820,2335,1
13821,2335,1
13823,2335,1
13824,2335,1
13825,2335,0
13826,2335,0
13827,2335,0
13828,2335,1
13829,2335,1
13830,2335,1
13831,2335,0
13832,2335,0
13833,2335,1
13834,2335,0
13835,2335,0
13836,2335,1
13837,2335,1
13838,2335,1
13839,2335,0
13840,2335,0
13841,2335,1
13842,2335,1
13843,2335,1
13849,2335,1
13850,2335,0
13851,2335,0
13852,2335,1
13853,2335,0
13854,2335,0
13855,2335,1
13856,2335,1
13858,2335,1
13859,2335,1
13862,2335,1
13863,2335,1
13864,2335,0
13865,2335,0
13866,2335,0
13867,2335,0
13868,2335,1
13869,2335,0
13870,2335,1
13871,2335,1
13872,2335,0
13873,2335,0
13874,2335,0
13875,2335,1
13876,2335,1
13877,2335,1
13878,2335,1
13879,2335,0
13880,2335,0
13881,2335,1
13882,2335,1
13883,2335,1
13884,2335,1
13885,2335,0
13887,2335,1
13888,2335,1
13889,2335,0
13890,2335,1
13891,2335,1
13892,2335,0
13893,2335,0
13894,2335,0
13895,2335,1
13896,2335,1
13897,2335,0
13900,2335,0
13901,2335,0
13902,2335,1
13903,2335,1
13904,2335,0
13905,2335,0
13907,2335,1
13908,2335,1
13909,2335,0
13910,2335,0
13911,2335,0
13912,2335,1
13913,2335,1
13914,2335,1
13915,2335,1
13916,2335,0
13917,2335,0
13918,2335,0
13924,2334,0
13925,2334,0
13926,2334,0
13928,2335,1
13929,2335,1
13930,2335,0
13931,2335,0
13932,2335,0
13933,2335,1
13934,2335,1
13935,2335,0
13936,2335,0
13937,2335,0
13938,2335,1
13939,2335,1
13940,2335,1
13941,2335,1
13942,2335,0
13943,2335,1
13944,2335,1
13945,2335,0
13946,2335,0
13947,2335,1
13948,2335,1
13949,2335,1
13950,2335,1
13951,2335,0
13952,2335,0
13954,2335,1
13955,2335,0
13956,2335,0
13958,2335,1
13959,2335,0
13963,2335,0
13964,2335,1
13965,2335,1
13967,2335,1
13968,2335,1
13969,2335,0
13970,2335,0
13971,2335,0
13972,2335,1
13973,2335,0
13975,2335,0
13976,2335,1
13977,2335,1
13978,2335,0
13979,2335,0
13981,2335,1
13982,2335,1
13983,2335,0
13984,2335,0
14016,2756,0
14017,2756,0
14060,2335,1
14061,2335,1
14062,2335,1
14063,2335,1
14064,2335,1
14066,2335,1
14067,2335,1
14071,2335,1
14072,2335,1
14073,2335,1
14076,2335,1
14077,2335,1
14078,2335,1
14079,2335,1
14080,2335,1
14082,2335,1
14083,2335,1
14085,2335,1
14086,2335,1
14087,2335,1
14088,2335,1
14089,2335,1
14091,2335,1
14092,2335,1
14093,2335,1
14095,2335,1
14096,2335,1
14097,2335,1
14098,2335,1
14099,2335,1
14100,2335,1
14103,2335,1
14104,2335,1
14105,2335,1
14106,2335,1
14107,2335,1
14108,2335,1
14109,2335,1
14110,2335,1
14123,2335,0
14136,2335,0
14223,1985,0
14245,2335,0
14252,2690,0
14255,2690,0
14256,2690,0
14262,2293,0
14269,2293,0
14284,2802,0
14285,2802,0
14513,2665,0
14598,2665,0
14913,2960,0
15082,3011,0
15083,3011,1
15090,3009,0
15146,3009,0
15976,2335,1
16086,2335,0
16087,2335,0
16088,2335,0
16089,2335,0
16151,2219,0
16223,2027,0
17989,2215,0
20549,3843,0
20553,3845,0
20555,3845,0
20564,3848,0
21952,2304,1
22408,2304,1
23757,3057,1
25452,5107,1
25453,5107,1
25454,5107,1
25573,2304,1
25574,2304,1
25575,2304,1
26033,5150,0
26042,5150,0
26584,5291,0
30687,6118,0
30993,5932,0
37090,5107,1
37821,6821,0
37822,6821,0
37877,6835,0
37881,6835,0
40948,6730,1
45056,4157,1
59843,1051,0
59844,1051,0
59845,1051,0
61962,2627,0
63222,2335,0
'''

@lru_cache
def get_obj_by_old_id(Model, old_id):
    return Model.objects.filter(old_id=old_id).first()


def update_figure_event_data(apps, _):
    Figure = apps.get_model('entry', 'Figure')
    Event = apps.get_model('event', 'Event')
    reader = csv.DictReader(
        StringIO(CSV_DATE),
        fieldnames=('figure_old_id', 'event_old_id', 'figure_role',),
    )
    next(reader)  # Skip header
    for row in reader:
        event_old_id = row['event_old_id']
        event = get_obj_by_old_id(Event, event_old_id)
        if event is None:
            print(f'Event old_id {event_old_id} missing...')
            continue
        # NOTE: old_id can have multiple result so doing this one by one for now
        Figure.objects.filter(old_id=row['figure_old_id']).update(
            event=event,
            role=row['figure_role'],
        )


class Migration(migrations.Migration):

    dependencies = [
        ('entry', '0082_regenerate_hazards_and_violences_of_event_and_figures'),
        ('event', '0031_fix_drought_and_cold_wave_data_migration'),
    ]

    operations = [
        migrations.RunPython(
            update_figure_event_data,
            reverse_code=migrations.RunPython.noop
        ),
    ]
